<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OAuth Redirect - Vaccination MAUI</title>
  <script>if(/Android/i.test(navigator.userAgent)){document.documentElement.classList.add('android');}</script>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:50px; background:#f5f5f5; margin:0 }
    .container { background:#fff; padding:30px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); max-width:500px; margin:40px auto }
    .success { color:#28a745; font-size:24px; margin-bottom:20px }
    .message { color:#666; margin-bottom:20px }
    .btn { background:#007bff; color:#fff; border:0; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:16px; margin:5px }
    .btn:hover { background:#0056b3 }
    .close-btn { background:#666; }
    .close-btn:hover { background:#555; }
    .status { margin-top:15px; padding:10px; border-radius:4px; font-size:14px; display:none; }
    .status.success { background-color:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status.info { background-color:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    /* Hide only on Android to avoid UI flash there */
    html.android body { display:none }
  </style>
  <script>
    (function () {
      var params = window.location.search || "";
      var deepLink = "vaccinationmaui://oauth2redirect" + params;
      var isAndroid = document.documentElement.classList.contains("android");

      // Function to show status messages
      function showStatus(message, type = 'info') {
        var statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.textContent = message;
          statusDiv.className = 'status ' + type;
          statusDiv.style.display = 'block';
        }
      }

      // Function to close window with multiple fallback methods
      function closeWindow() {
        showStatus('Attempting to close window...', 'info');
        
        // Method 1: Try window.close()
        try {
          if (window.close()) {
            showStatus('Window closed successfully!', 'success');
            return;
          }
        } catch (e) {
          console.log('window.close() failed:', e);
        }
        
        // Method 2: Try to close using window.opener if available
        if (window.opener && !window.opener.closed) {
          try {
            window.opener.close();
            window.close();
            showStatus('Window closed via opener!', 'success');
            return;
          } catch (e) {
            console.log('window.opener.close() failed:', e);
          }
        }
        
        // Method 3: Try to focus the opener and close this window
        if (window.opener) {
          try {
            window.opener.focus();
            window.close();
            showStatus('Window closed and focus returned to opener!', 'success');
            return;
          } catch (e) {
            console.log('focus and close failed:', e);
          }
        }
        
        // Method 4: Try to minimize the window
        try {
          window.moveTo(0, 0);
          window.resizeTo(1, 1);
          showStatus('Window minimized. You can close it manually.', 'info');
          return;
        } catch (e) {
          console.log('minimize failed:', e);
        }
        
        // Method 5: Final fallback - show instructions
        showStatus('Please close this window manually using Alt+F4 or the X button.', 'info');
      }

      if (isAndroid) {
        // ANDROID: redirect immediately, no flash
        window.location.replace(deepLink);
        // Fallback if app doesn't open quickly
        setTimeout(function () {
          document.documentElement.classList.remove("android");
          document.body.innerHTML =
            "<div class='container'><div class='message'>If your app did not open, please install it and try again.</div></div>";
        }, 1200);
      } else {
        // WINDOWS/others: show UI and also attempt deep link
        window.addEventListener("DOMContentLoaded", function () {
          document.getElementById("returnBtn").onclick = function () { window.location.href = deepLink; };
          document.getElementById("closeBtn").onclick = function () { closeWindow(); };
          setTimeout(function () { window.location.href = deepLink; }, 300);
        });
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="success">âœ… Authentication Successful!</div>
    <div class="message">You have successfully signed in with Google.<br>Click the button below to return to your app.</div>
    <button class="btn" id="returnBtn">Return to App</button>
    <button class="btn close-btn" id="closeBtn">Close Window</button>
    <div id="status" class="status"></div>
  </div>
</body>
</html>
